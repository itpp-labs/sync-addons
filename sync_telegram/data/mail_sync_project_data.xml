<?xml version='1.0' encoding='UTF-8'?>
<!-- Copyright 2021 ilya ilchenko
     License MIT (https://opensource.org/licenses/MIT). -->
<odoo>

  <record id="telegram_task_odoo2tele" model="sync.task">
    <field name="name">Send response via Odoo</field>
    <field name="active" eval="True"/>
    <field name="project_id" ref="telegram_project"/>
    <field name="code"><![CDATA[
def handle_db(records):
    # records are instances of mail.message
    for r in records:
        log("MESSAGE data: %s - %s - %s" % (r.res_id, r.author_id.id, r.body), LOG_DEBUG)
      
        if not html2plaintext(r.body or ""):
            continue

        channel = env["mail.channel"].browse(r.res_id)

        for partner in channel.channel_partner_ids:
          if partner.ref:
            contact_name = partner.ref
          else:
            admin_id = partner.id
            
          
        if r.author_id.id == admin_id:
          telegram_user_id = contact_name.split("@telegram")[0]
          telegram_message_html = html_sanitize_telegram(r.body)
          telegram.sendMessage(telegram_user_id, telegram_message_html)
        ]]></field>
  </record>
  <record id="telegram_trigger_automation" model="sync.trigger.automation">
    <field name="trigger_name">ON_MESSAGE_POSTED</field>
    <field name="active" eval="True"/>
    <field name="sync_task_id" ref="telegram_task_odoo2tele"/>
    <field name="model_id" ref="mail.model_mail_message"/>
    <field name="trigger">on_create</field>
    <field name="filter_domain">
            [["model","=","mail.channel"]]
    </field>
  </record>
</odoo>
